# ‚öôÔ∏è Critical Flows (URL shortener system)

This section documents the core end-to-end flows in URL-Shortener system. It emphasizes **session-based authentication**, converting URLs to short URLs and redirecting to the original URLs when a short URL is hit


## üîë 0. User Login (Note: User doesn't have to login to create short URLs, this is only for additional features where the User can view all the short URLs they've created in their dashboard)

**Goal:** Authenticate the user and issue a token for subsequent requests.  

| Step | Component                             | Action                                            |
| ---- | ------------------------------------- | ------------------------------------------------- |
| 1    | **User ‚Üí API Gateway ‚Üí Auth Service** | POST `/login` with email/password                 |
| 2    | **Auth Service**                      | Validates credentials, generates JWT              |
| 3    | **API Gateway ‚Üí User**                | Returns JWT                                       |
| 4    | **User ‚Üí API Gateway ‚Üí URL Service**  | Sends requests with `Authorization: Bearer <jwt>` |
| 5    | **API Gateway**                       | Validates token (signature + expiry)              |
| 6    | **URL Service**                       | Uses `user_id` claim to fetch URLs                |

**JWT Token:** A JWT (JSON Web Token) consists of three dot-separated parts ‚Äî header, payload, and signature.  
The signature is generated by hashing (and signing) the header and payload using a secret key or private key.  
When the server validates a request, it recomputes the signature from the header and payload using its own key and compares it against the token‚Äôs signature.
If they match, the token is authentic and unmodified.
This means an attacker cannot alter the payload (for example, changing "admin": false to "admin": true") ‚Äî because any change to the payload would produce a different signature, and without the secret key, the attacker can‚Äôt generate a matching one.

## 1. Creating Short URLs:

| Step | Component                             | Action                                            |
| ---- | ------------------------------------- | ------------------------------------------------- |
| 1    | **User ‚Üí API Gateway ‚Üí URL shortener service** | 
| 2    | **URL shortener**                      | Generates a Shortened URL |
| 3    | **API Gateway ‚Üí User**                | Returns the shortened URL

## 2. Redirect User to original URL:

| Step | Component | Action |
|------|------------|--------|
| 1 | **User ‚Üí API Gateway ‚Üí URL Shortener Service** | Sends a **GET** request with the short code (e.g., `short.url/xyz`). |
| 2 | **URL Shortener** | Looks up the short code (`xyz`) in the data store to retrieve the original long URL. |
| 3 | **URL Shortener ‚Üí API Gateway ‚Üí User** | Sends an **HTTP 302 Found** (or **301 Moved Permanently**) response, setting the `Location` header to the original long URL. |
| 4 | **User (Browser)** | Automatically interprets the 302 response and sends a new **GET** request to the URL specified in the `Location` header. |

## 3. Access saved URLs:

Note: These actions would only be allowed after the user logs in to the service -> the user would get a JWT when they login and that's used as the means of authentication in this flow

| Step | Component                            | Action                                                                                                                                                                             |
| ---- | ------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1    | **User ‚Üí API Gateway ‚Üí URL Service** | `GET /me/urls?page=1&size=20&sort=created_at:desc` with `Authorization: Bearer <jwt>`                                                                                              |
| 2    | **API Gateway**                      | Validates JWT (signature + expiry). Injects `user_id` from token into downstream request or sets header `X-User-Id`. Reject if token invalid.                                      |
| 3    | **URL Service**                      | Authorizes: ensure `X-User-Id` == owner id used for DB query. Query datastore with index on `owner_id`, apply pagination, filters, and return list + metadata (total, page, size). |
| 4    | **URL Service ‚Üí API Gateway ‚Üí User** | Returns `200 OK` with JSON: `{ items:[...], page, size, total }`.                                                                |


## 4. Save a URL to their dashboard:

Note: These actions would only be allowed after the user logs in to the service -> the user would get a JWT when they login and that's used as the means of authentication in this flow

| Step | Component                            | Action                                                                                                                                                                                                                                                                                                             |
|------|--------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1    | **User ‚Üí API Gateway ‚Üí URL Service** | `POST /me/urls` with body `{ "long_url": "...", "custom_short": "abc" (optional), "tags": [], "visibility": "private" }` and header `Authorization: Bearer <jwt>`                                                                                                                                                  |
| 2    | **API Gateway**                      | Verifies the JWT (signature, expiry), extracts the `user_id` from it, and adds it to the request (e.g. as `X-User-Id: 12345`) before forwarding the request to the URL Service.                                                                                                                                     |
| 3    | **URL Service**                      | Validates input (URL format, allowed schemes), normalizes the URL (e.g. strip tracking params). Generates the short code **atomically** and saves it with the user's ID.                                       |
| 4    | **URL Service ‚Üí API Gateway ‚Üí User** | On success: return `201 Created` with `Location: /me/urls/{id}` and the new short URL details. If a duplicate is found (e.g. same long URL already saved), return `200 OK` with existing resource.                                               |
